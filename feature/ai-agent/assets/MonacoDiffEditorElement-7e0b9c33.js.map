{"version":3,"file":"MonacoDiffEditorElement-7e0b9c33.js","sources":["../../packages/shared/src/components/MonacoDiffEditor/useAddLineControls.tsx","../../packages/shared/src/components/MonacoDiffEditor/useMonacoDiffEditorElement.ts","../../packages/shared/src/components/MonacoDiffEditor/MonacoDiffEditorElement.tsx"],"sourcesContent":["import { editor as Editor, Range } from 'monaco-editor'\nimport type { Dispatch, MutableRefObject, SetStateAction } from 'react'\nimport { useEffect, useRef } from 'react'\nimport { useParams } from 'react-router'\nimport type { RevertChangeInAiEnhancedPackageVersionMutationFn } from '../../entities/ai-agent'\n\nconst RawDiffTypes = {\n  add: 'add',\n  remove: 'remove',\n  change: 'change',\n}\ntype RawDiffType = typeof RawDiffTypes[keyof typeof RawDiffTypes]\n\nexport function useAddLineControls(\n  editor: MutableRefObject<Editor.IStandaloneDiffEditor | undefined>,\n  setRevertedChange: Dispatch<SetStateAction<Editor.ILineChange | undefined>>,\n  setViewSnapshot?: Dispatch<SetStateAction<{ scrollTop: number; firstVisibleLine?: number } | undefined>>,\n  saveRevertChange?: RevertChangeInAiEnhancedPackageVersionMutationFn,\n): void {\n  const { packageId, versionId, documentId } = useParams()\n\n  const widgetsRef = useRef<Editor.IGlyphMarginWidget[]>([])\n  const modelIdRef = useRef<string | null>(null)\n  const disposableRef = useRef<{ dispose: () => void } | null>(null)\n\n  useEffect(() => {\n    if (!editor.current) {\n      return\n    }\n\n    const diffEditor = editor.current\n    const modifiedEditor = diffEditor.getModifiedEditor()\n    const originalEditor = diffEditor.getOriginalEditor()\n    const model = diffEditor.getModel()\n\n    if (!model) {\n      return\n    }\n\n    const currentModelId = model.modified.uri.toString()\n\n    // Only create widgets if model changed\n    if (modelIdRef.current === currentModelId) {\n      return\n    }\n\n    modelIdRef.current = currentModelId\n\n    // Cleanup previous subscription and widgets\n    if (disposableRef.current) {\n      disposableRef.current.dispose()\n    }\n\n    const currentWidgets = widgetsRef.current\n\n    currentWidgets.forEach((widget) => {\n      // Remove from both editors\n      try {\n        modifiedEditor.removeGlyphMarginWidget(widget)\n      } catch (_) {\n        // Widget might not exist in this editor\n      }\n      try {\n        originalEditor.removeGlyphMarginWidget(widget)\n      } catch (_) {\n        // Widget might not exist in this editor\n      }\n    })\n\n    widgetsRef.current = []\n\n    // Function to add line controls\n    const addLineControls = (): void => {\n      // Clean up existing widgets before adding new ones\n      widgetsRef.current.forEach((widget) => {\n        try {\n          modifiedEditor.removeGlyphMarginWidget(widget)\n        } catch (_) {\n          // Widget might not exist in this editor\n        }\n        try {\n          originalEditor.removeGlyphMarginWidget(widget)\n        } catch (_) {\n          // Widget might not exist in this editor\n        }\n      })\n\n      const lineChanges = diffEditor.getLineChanges()\n\n      if (!lineChanges) {\n        return\n      }\n\n      const widgets: Editor.IGlyphMarginWidget[] = []\n\n      // Create a glyph margin widget only for lines in changed fragments\n      lineChanges.forEach((change) => {\n        // Get the range of lines for this change\n        const {\n          originalStartLineNumber,\n          originalEndLineNumber,\n          modifiedStartLineNumber,\n          modifiedEndLineNumber,\n        } = change\n\n        const diffType: RawDiffType = detectDiffType(change)\n\n        // Create button helper function\n        const createButton = (): HTMLButtonElement => {\n          const button = document.createElement('button')\n          button.className = 'monaco-diff-revert-button'\n          button.innerHTML = '<svg viewBox=\"0 0 14 14\" width=\"14\" height=\"14\" style=\"margin: 0 4px;\"><path d=\"M4.37934 0.21934C4.51979 0.359965 4.59868 0.550589 4.59868 0.74934C4.59868 0.948091 4.51979 1.13871 4.37934 1.27934L2.55934 3.09934H7.79934C8.51504 3.09934 9.22374 3.24031 9.88496 3.5142C10.5462 3.78808 11.147 4.18953 11.6531 4.69561C12.1592 5.20169 12.5606 5.80249 12.8345 6.46372C13.1084 7.12494 13.2493 7.83364 13.2493 8.54934C13.2493 9.26504 13.1084 9.97374 12.8345 10.635C12.5606 11.2962 12.1592 11.897 11.6531 12.4031C11.147 12.9092 10.5462 13.3106 9.88496 13.5845C9.22374 13.8584 8.51504 13.9993 7.79934 13.9993H3.14934C2.95043 13.9993 2.75966 13.9203 2.61901 13.7797C2.47836 13.639 2.39934 13.4483 2.39934 13.2493C2.39934 13.0504 2.47836 12.8597 2.61901 12.719C2.75966 12.5784 2.95043 12.4993 3.14934 12.4993H7.79934C8.84695 12.4993 9.85164 12.0832 10.5924 11.3424C11.3332 10.6016 11.7493 9.59695 11.7493 8.54934C11.7493 7.50174 11.3332 6.49704 10.5924 5.75627C9.85164 5.0155 8.84695 4.59934 7.79934 4.59934H2.55934L4.37934 6.41934C4.51182 6.56151 4.58394 6.74956 4.58051 6.94386C4.57709 7.13816 4.49837 7.32355 4.36096 7.46096C4.22355 7.59838 4.03816 7.67709 3.84386 7.68052C3.64956 7.68394 3.46152 7.61182 3.31934 7.47934L0.21934 4.37934C0.0788896 4.23871 0 4.04809 0 3.84934C0 3.65059 0.0788896 3.45997 0.21934 3.31934L3.31934 0.21934C3.45997 0.0788896 3.65059 0 3.84934 0C4.04809 0 4.23871 0.0788896 4.37934 0.21934Z\"/></svg>'\n          button.style.cssText = 'cursor: pointer; border: none; background: none; padding: 0; width: 100%; text-align: center; display: flex; align-items: center; justify-content: center;'\n\n          button.onclick = (e) => {\n            e.preventDefault()\n            e.stopPropagation()\n            // Capture current viewport state before triggering revert\n            try {\n              const currentRanges = modifiedEditor.getVisibleRanges()\n              const firstVisibleLine = currentRanges?.[0]?.startLineNumber\n              const scrollTop = modifiedEditor.getScrollTop()\n              setViewSnapshot?.({ scrollTop, firstVisibleLine })\n            } catch (_) {\n              // ignore snapshot errors\n            }\n            const originalValue = diffEditor.getModel()?.original.getValue()\n            const modifiedValue = diffEditor.getModel()?.modified.getValue()\n            if (originalValue && modifiedValue) {\n              const valueWithRevertedChange = revertChangeLocally(originalValue, modifiedValue, change)\n              saveRevertChange?.({\n                packageId: packageId ?? '',\n                version: versionId ?? '',\n                slug: documentId ?? '',\n                content: valueWithRevertedChange,\n              })\n              setRevertedChange(change)\n            }\n          }\n\n          return button\n        }\n\n        // Place one widget per change at the first line\n        if (diffType === RawDiffTypes.remove) {\n          // For remove: place widget on the ORIGINAL editor at the first removed line\n          const lineNumber = originalStartLineNumber\n          const range = new Range(lineNumber, 1, lineNumber, 1)\n\n          const widget: Editor.IGlyphMarginWidget = {\n            getId: () => `line-control-remove-${originalStartLineNumber}-${originalEndLineNumber}`,\n            getDomNode: createButton,\n            getPosition: () => ({\n              lane: Editor.GlyphMarginLane.Right,\n              zIndex: 10,\n              range: range,\n            }),\n          }\n\n          originalEditor.addGlyphMarginWidget(widget)\n          widgets.push(widget)\n        } else if (diffType === RawDiffTypes.add) {\n          // For add: place widget on the MODIFIED editor at the first added line\n          const lineNumber = modifiedStartLineNumber\n          const range = new Range(lineNumber, 1, lineNumber, 1)\n\n          const widget: Editor.IGlyphMarginWidget = {\n            getId: () => `line-control-add-${modifiedStartLineNumber}-${modifiedEndLineNumber}`,\n            getDomNode: createButton,\n            getPosition: () => ({\n              lane: Editor.GlyphMarginLane.Right,\n              zIndex: 10,\n              range: range,\n            }),\n          }\n\n          modifiedEditor.addGlyphMarginWidget(widget)\n          widgets.push(widget)\n        } else if (diffType === RawDiffTypes.change) {\n          // For change: place widget on the MODIFIED editor at the first changed line\n          const lineNumber = modifiedStartLineNumber\n          const range = new Range(lineNumber, 1, lineNumber, 1)\n\n          const widget: Editor.IGlyphMarginWidget = {\n            getId: () => `line-control-change-${modifiedStartLineNumber}-${modifiedEndLineNumber}`,\n            getDomNode: createButton,\n            getPosition: () => ({\n              lane: Editor.GlyphMarginLane.Right,\n              zIndex: 10,\n              range: range,\n            }),\n          }\n\n          modifiedEditor.addGlyphMarginWidget(widget)\n          widgets.push(widget)\n        }\n      })\n\n      widgetsRef.current = widgets\n    }\n\n    // Try to add controls immediately\n    addLineControls()\n\n    // Subscribe to diff updates to add controls when diff is computed\n    disposableRef.current = diffEditor.onDidUpdateDiff(() => { addLineControls() })\n\n    return () => { disposableRef.current?.dispose() }\n  }, [documentId, editor, packageId, saveRevertChange, setRevertedChange, setViewSnapshot, versionId])\n}\n\n/**\n * Receives original and modified values and a change and returns modified value with reverted change\n * Logic:\n * - add: Remove added lines from modifiedValue\n * - remove: Insert removed lines from originalValue back into modifiedValue\n * - change: Replace changed lines in modifiedValue with lines from originalValue\n * @param originalValue Original value\n * @param modifiedValue Modified value\n * @param change MonacoEditor line change\n * @returns Modified value with reverted change\n */\nfunction revertChangeLocally(\n  originalValue: string,\n  modifiedValue: string,\n  change: Editor.ILineChange,\n): string {\n  const originalLines = originalValue.split('\\n')\n  const modifiedLines = modifiedValue.split('\\n')\n\n  const diffType: RawDiffType = detectDiffType(change)\n\n  if (diffType === RawDiffTypes.add) {\n    // Remove added lines from modifiedValue\n    const updatedModifiedLines = [...modifiedLines]\n    const linesToRemove = change.modifiedEndLineNumber - change.modifiedStartLineNumber + 1\n    updatedModifiedLines.splice(change.modifiedStartLineNumber - 1, linesToRemove)\n    return updatedModifiedLines.join('\\n')\n  }\n\n  if (diffType === RawDiffTypes.remove) {\n    // Insert removed lines from originalValue back into modifiedValue\n    const pickedOriginalLines = originalLines.slice(\n      change.originalStartLineNumber - 1,\n      change.originalEndLineNumber,\n    )\n    const updatedModifiedLines = [...modifiedLines]\n    // Insert at the position where the deletion occurred in the modified editor\n    updatedModifiedLines.splice(change.originalStartLineNumber - 1, 0, ...pickedOriginalLines)\n    return updatedModifiedLines.join('\\n')\n  }\n\n  if (diffType === RawDiffTypes.change) {\n    // Replace changed lines in modifiedValue with original lines\n    const pickedOriginalLines = originalLines.slice(\n      change.originalStartLineNumber - 1,\n      change.originalEndLineNumber,\n    )\n    const updatedModifiedLines = [...modifiedLines]\n    const linesToReplace = change.modifiedEndLineNumber - change.modifiedStartLineNumber + 1\n    updatedModifiedLines.splice(change.modifiedStartLineNumber - 1, linesToReplace, ...pickedOriginalLines)\n    return updatedModifiedLines.join('\\n')\n  }\n\n  return ''\n}\n\n/**\n * Detects diff type from MonacoEditor line change\n * Variants:\n * - add: The line(s) has(ve) been added (no lines in original editor)\n * - remove: The line(s) has(ve) been removed (no lines in modified editor)\n * - change: The line has been changed (lines exist in both editors)\n * @param change MonacoEditor line change\n * @returns Diff type\n */\nfunction detectDiffType(change: Editor.ILineChange): RawDiffType {\n  const {\n    originalStartLineNumber,\n    originalEndLineNumber,\n    modifiedStartLineNumber,\n    modifiedEndLineNumber,\n  } = change\n\n  // Check if no lines in original editor (pure addition)\n  const hasOriginalLines = originalEndLineNumber >= originalStartLineNumber && originalStartLineNumber > 0\n\n  // Check if no lines in modified editor (pure removal)\n  const hasModifiedLines = modifiedEndLineNumber >= modifiedStartLineNumber && modifiedStartLineNumber > 0\n\n  if (!hasOriginalLines) {\n    return RawDiffTypes.add\n  }\n\n  if (!hasModifiedLines) {\n    return RawDiffTypes.remove\n  }\n\n  return RawDiffTypes.change\n}\n","/**\n * Copyright 2024-2025 NetCracker Technology Corporation\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { editor as Editor, Range } from 'monaco-editor'\nimport type { RefObject } from 'react'\nimport { useEffect, useRef, useState } from 'react'\nimport { useEffectOnce } from 'react-use'\nimport type { RevertChangeInAiEnhancedPackageVersionMutationFn } from '../../entities/ai-agent'\nimport type { LanguageType } from '../../types/languages'\nimport { LANGUAGE_TYPE_TEXT } from '../../types/languages'\nimport type { SpecItemUri } from '../../utils/specifications'\nimport { findPathLocation } from '../../utils/specifications'\nimport type { SpecType } from '../../utils/specs'\nimport { useAddLineControls } from './useAddLineControls'\n\ntype EditorViewportSnapshot = {\n  scrollTop: number\n  firstVisibleLine?: number\n}\n\ntype UseMonacoDiffEditorElementOptions = {\n  before: string\n  after: string\n  type: SpecType\n  language?: LanguageType\n  selectedUri?: SpecItemUri\n  requestRevertChange?: RevertChangeInAiEnhancedPackageVersionMutationFn\n}\n\nexport function useMonacoDiffEditorElement(\n  options: UseMonacoDiffEditorElementOptions,\n): RefObject<HTMLDivElement> {\n  const { before, after, type, language = LANGUAGE_TYPE_TEXT, selectedUri, requestRevertChange } = options\n\n  const ref = useRef<HTMLDivElement>(null)\n  const editor = useRef<Editor.IStandaloneDiffEditor>()\n\n  const [revertedChange, setRevertedChange] = useState<Editor.ILineChange | undefined>(undefined)\n  const [viewSnapshot, setViewSnapshot] = useState<EditorViewportSnapshot | undefined>(undefined)\n\n  useEffectOnce(() => {\n    Editor.defineTheme('custom', {\n      base: 'vs',\n      inherit: true,\n      rules: [],\n      colors: {\n        'editor.background': '#FFFFFF',\n      },\n    })\n\n    editor.current = Editor.createDiffEditor(ref.current!, {\n      minimap: { enabled: true },\n      hover: { above: false },\n      automaticLayout: true,\n      readOnly: true,\n      wordWrap: 'on',\n      glyphMargin: true,\n      theme: 'custom',\n      stickyScroll: { enabled: false },\n    })\n\n    return () => {\n      try {\n        editor.current?.setModel(null)\n      } catch (_) {\n        // editor might already be disposed; ignore\n      }\n      editor.current?.dispose()\n      // prevent future calls on a disposed instance\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      editor.current = undefined\n    }\n  })\n\n  useEffect(() => {\n    //todo resolve problem with load schema model by filename (like in useSetEditorModel)\n\n    // Capture current scroll position before model swap to prevent jump to top\n    const modifiedEditor = editor.current?.getModifiedEditor()\n    const previousScrollTop = modifiedEditor?.getScrollTop() ?? 0\n\n    const originalModel = Editor.createModel(before, language)\n    const modifiedModel = Editor.createModel(after, language)\n\n    editor.current?.setModel({\n      original: originalModel,\n      modified: modifiedModel,\n    })\n\n    // TODO 06.11.25 // Is branch \"else\" necessary?\n    if (revertedChange) {\n      // If we have a pre-revert viewport snapshot, restore it; otherwise, navigate to the change\n      if (viewSnapshot) {\n        restoreView(editor.current!, viewSnapshot)\n        // Clear the restoration state after first restoration to prevent repeated attempts\n        setViewSnapshot(undefined)\n        setRevertedChange(undefined)\n      } else {\n        const startLine = revertedChange.modifiedStartLineNumber\n        startLine !== undefined && navigateTo(editor.current!, startLine)\n        // Clear after navigation\n        setRevertedChange(undefined)\n      }\n    } else {\n      // Immediately restore scroll position after model swap to prevent visible jump\n      if (modifiedEditor && previousScrollTop > 0) {\n        modifiedEditor.setScrollTop(previousScrollTop, Editor.ScrollType.Immediate)\n      }\n    }\n\n    return () => {\n      const { current } = editor\n      const currentModel = current?.getModel()\n\n      // Detach only if the editor still uses the models created by this render\n      if (\n        current &&\n        currentModel &&\n        currentModel.original === originalModel &&\n        currentModel.modified === modifiedModel\n      ) {\n        try {\n          current.setModel(null)\n        } catch (_) {\n          // editor may have been disposed concurrently; ignore\n        }\n      }\n\n      originalModel.dispose()\n      modifiedModel.dispose()\n    }\n  }, [editor, before, after, language, type, revertedChange, viewSnapshot])\n\n  useAddLineControls(editor, setRevertedChange, setViewSnapshot, requestRevertChange)\n\n  useEffect(() => {\n    const content = editor.current?.getModel()?.modified.getValue()\n    if (content && selectedUri) {\n      const location = findPathLocation(content, selectedUri)\n      const startLine = location?.range.start.line\n      startLine !== undefined && navigateTo(editor.current!, startLine + 1)\n    }\n  }, [selectedUri])\n\n  return ref\n}\n\nfunction navigateTo(\n  editor: Editor.IStandaloneDiffEditor,\n  lineNumber: number,\n): void {\n  const modifiedEditor = editor.getModifiedEditor()\n\n  // Keep navigation resilient during a short stabilization window\n  const stabilizeMs = 300\n  const endTime = Date.now() + stabilizeMs\n  let lastApply = 0\n  const applyIntervalMs = 30\n  const applyNavigate = (): void => {\n    const now = Date.now()\n    if (now - lastApply < applyIntervalMs) return\n    lastApply = now\n    const targetRange = new Range(lineNumber, 1, lineNumber, 1)\n    modifiedEditor.revealRangeNearTop(targetRange, Editor.ScrollType.Smooth)\n    modifiedEditor.setSelection(targetRange)\n    modifiedEditor.focus()\n  }\n\n  // Try immediately if models are ready\n  const model = modifiedEditor.getModel()\n  if (model) {\n    // Schedule to the next frame to wait for layout after model swap\n    requestAnimationFrame(() => {\n      applyNavigate()\n    })\n  }\n\n  // Also listen for diff update/layout as a robust fallback (fires after model attach/layout)\n  const disposables: { dispose: () => void }[] = []\n  const disposeAll = (): void => {\n    disposables.forEach(d => {\n      try {\n        d.dispose()\n      } catch (_) {\n        // ignore\n      }\n    })\n  }\n\n  disposables.push(\n    editor.onDidUpdateDiff(() => {\n      applyNavigate()\n      if (Date.now() > endTime) disposeAll()\n    }),\n  )\n\n  disposables.push(\n    modifiedEditor.onDidLayoutChange(() => {\n      applyNavigate()\n      if (Date.now() > endTime) disposeAll()\n    }),\n  )\n\n  // Also react to unexpected scroll resets during stabilization\n  disposables.push(\n    modifiedEditor.onDidScrollChange(() => {\n      applyNavigate()\n      if (Date.now() > endTime) disposeAll()\n    }),\n  )\n\n  // Final timer-based fallback in case neither event fires (e.g., no diff)\n  setTimeout(() => {\n    applyNavigate()\n    if (Date.now() > endTime) disposeAll()\n  }, 50)\n\n  // Robustness: retry a few times until the line is actually visible\n  let attemptsRemaining = 3\n  const tryEnsureVisible = (): void => {\n    const ranges = modifiedEditor.getVisibleRanges()\n    const isVisible = ranges.some(r => r.startLineNumber <= lineNumber && r.endLineNumber >= lineNumber)\n    const scrolled = modifiedEditor.getScrollTop() > 0 || lineNumber === 1\n    if (isVisible || scrolled || attemptsRemaining <= 0) return\n    attemptsRemaining -= 1\n    setTimeout(() => {\n      const targetRange = new Range(lineNumber, 1, lineNumber, 1)\n      modifiedEditor.revealRangeNearTop(targetRange, Editor.ScrollType.Smooth)\n      requestAnimationFrame(tryEnsureVisible)\n    }, 60)\n  }\n  requestAnimationFrame(tryEnsureVisible)\n}\n\nfunction restoreView(\n  editor: Editor.IStandaloneDiffEditor,\n  snapshot: { scrollTop: number; firstVisibleLine?: number },\n): void {\n  const modifiedEditor = editor.getModifiedEditor()\n\n  const stabilizeMs = 300\n  const endTime = Date.now() + stabilizeMs\n  let lastApply = 0\n  const applyIntervalMs = 30\n\n  const applyRestore = (): void => {\n    const now = Date.now()\n    if (now - lastApply < applyIntervalMs) return\n    lastApply = now\n\n    // Prefer firstVisibleLine-based restoration for better stability after content changes\n    if (snapshot.firstVisibleLine !== undefined) {\n      const targetRange = new Range(snapshot.firstVisibleLine, 1, snapshot.firstVisibleLine, 1)\n      // Use revealRangeAtTop for precise positioning without padding\n      modifiedEditor.revealRangeAtTop(targetRange, Editor.ScrollType.Immediate)\n    } else {\n      // Fallback to scrollTop if firstVisibleLine is not available\n      modifiedEditor.setScrollTop(snapshot.scrollTop, Editor.ScrollType.Immediate)\n    }\n  }\n\n  const disposables: { dispose: () => void }[] = []\n  const disposeAll = (): void => {\n    disposables.forEach(d => {\n      try {\n        d.dispose()\n      } catch (_) {\n        // ignore\n      }\n    })\n  }\n\n  requestAnimationFrame(applyRestore)\n\n  disposables.push(\n    editor.onDidUpdateDiff(() => {\n      applyRestore()\n      if (Date.now() > endTime) disposeAll()\n    }),\n  )\n  disposables.push(\n    modifiedEditor.onDidLayoutChange(() => {\n      applyRestore()\n      if (Date.now() > endTime) disposeAll()\n    }),\n  )\n  disposables.push(\n    modifiedEditor.onDidScrollChange(() => {\n      // Keep the previous viewport during stabilization\n      applyRestore()\n      if (Date.now() > endTime) disposeAll()\n    }),\n  )\n\n  setTimeout(() => {\n    applyRestore()\n    if (Date.now() > endTime) disposeAll()\n  }, 50)\n}\n","/**\n * Copyright 2024-2025 NetCracker Technology Corporation\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport 'monaco-editor/esm/vs/basic-languages/markdown/markdown.contribution'\nimport 'monaco-editor/esm/vs/basic-languages/yaml/yaml.contribution'\nimport 'monaco-editor/esm/vs/editor/editor.all.js'\nimport 'monaco-editor/esm/vs/language/json/monaco.contribution'\n\nimport type { FC } from 'react'\nimport { memo } from 'react'\nimport type { RevertChangeInAiEnhancedPackageVersionMutationFn } from '../../entities/ai-agent'\nimport type { LanguageType } from '../../types/languages'\nimport type { SpecItemUri } from '../../utils/specifications'\nimport type { SpecType } from '../../utils/specs'\nimport { useMonacoDiffEditorElement } from './useMonacoDiffEditorElement'\n\nexport type MonacoDiffEditorElementProps = {\n  before: string\n  after: string\n  type: SpecType\n  language?: LanguageType\n  selectedUri?: SpecItemUri\n  // Only for tab \"AI Agent\"\n  requestRevertChange?: RevertChangeInAiEnhancedPackageVersionMutationFn\n}\n\nconst MonacoDiffEditorElement: FC<MonacoDiffEditorElementProps> = memo<MonacoDiffEditorElementProps>(props => {\n  const {\n    before,\n    after,\n    type,\n    language,\n    selectedUri,\n    requestRevertChange,\n  } = props\n\n  const element = useMonacoDiffEditorElement({\n    before,\n    after,\n    type,\n    language,\n    selectedUri,\n    requestRevertChange,\n  })\n\n  return (\n    <div\n      ref={element}\n      style={{ height: '100%' }}\n    />\n  )\n})\n\nexport default MonacoDiffEditorElement\n"],"names":["RawDiffTypes","useAddLineControls","editor","setRevertedChange","setViewSnapshot","saveRevertChange","packageId","versionId","documentId","useParams","widgetsRef","useRef","modelIdRef","disposableRef","useEffect","diffEditor","modifiedEditor","originalEditor","model","currentModelId","widget","addLineControls","lineChanges","widgets","change","originalStartLineNumber","originalEndLineNumber","modifiedStartLineNumber","modifiedEndLineNumber","diffType","detectDiffType","createButton","button","e","currentRanges","firstVisibleLine","_a","scrollTop","originalValue","_b","modifiedValue","_c","valueWithRevertedChange","revertChangeLocally","lineNumber","range","Range","Editor","originalLines","modifiedLines","updatedModifiedLines","linesToRemove","pickedOriginalLines","linesToReplace","hasOriginalLines","hasModifiedLines","useMonacoDiffEditorElement","options","before","after","type","language","LANGUAGE_TYPE_TEXT","selectedUri","requestRevertChange","ref","revertedChange","useState","viewSnapshot","useEffectOnce","previousScrollTop","originalModel","modifiedModel","restoreView","startLine","navigateTo","current","currentModel","content","location","findPathLocation","stabilizeMs","endTime","lastApply","applyIntervalMs","applyNavigate","now","targetRange","disposables","disposeAll","d","attemptsRemaining","tryEnsureVisible","isVisible","r","scrolled","snapshot","applyRestore","MonacoDiffEditorElement","memo","props","element","jsx"],"mappings":"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"}